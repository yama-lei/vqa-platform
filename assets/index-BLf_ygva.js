import{q as f,W as _e,y as ve,c as b,o as n,j as a,a as l,w as s,r as u,G as p,u as i,X as ye,s as d,x as h,K,J as U,F as ge,v as we,h as c,n as be,Y as ke,l as O,H as J,I as G,C as P,O as Se,A as _,Z as he,_ as xe}from"./vendor-DQ4wclxO.js";import{t as Ce,l as Fe,d as Ne,u as $e,a as Ve}from"./oss-B6tvshPE.js";import{_ as Be}from"./_plugin-vue_export-helper-DlAUqK2U.js";const je={class:"upload-container"},Oe={class:"content-section"},Ee={class:"tabs-container"},Ie={class:"upload-area"},Te={class:"upload-icon-container"},Me={key:0,class:"upload-progress"},Ue={class:"progress-text"},Ae={key:1,class:"upload-result success"},De={class:"alert-actions"},He={key:2,class:"upload-result error"},Le={key:3,class:"file-info"},ze={class:"file-items-container"},Ke={class:"file-name"},Je={class:"file-size"},Ge={class:"file-form"},Pe={class:"form-buttons"},Xe={class:"upload-history"},Ze={class:"file-name-cell"},Re={class:"operation-buttons"},qe={class:"preview-container"},We={class:"unknown-preview"},Ye={__name:"index",setup(Qe){const E=f("file"),w=f([]),k=f(!1),N=f(!1),I=f(null),$=f(0),v=f(""),V=f(""),x=f(null),m=_e({type:"",description:""}),g=f([]),X=t=>{console.log("文件变化:",t),w.value=[t],m.type=ee(t.name)},Z=t=>{console.log("文件移除:",t)},R=t=>/\.(pdf|doc|docx|txt)$/i.test(t),q=t=>/\.(py|js|java|c|cpp|h|html|css|json|xml)$/i.test(t),W=t=>/\.(jpg|jpeg|png|gif|svg|webp)$/i.test(t),Y=t=>/\.(mp4|avi|mov|wmv|flv|mkv|webm)$/i.test(t),Q=t=>t<1024?t+" B":t<1024*1024?(t/1024).toFixed(2)+" KB":t<1024*1024*1024?(t/(1024*1024)).toFixed(2)+" MB":(t/(1024*1024*1024)).toFixed(2)+" GB",ee=t=>{const e=t.split(".").pop().toLowerCase();return["pdf","doc","docx"].includes(e)?"paper":["md","txt"].includes(e)?"note":["mp4","avi","mov","webm"].includes(e)?"video":["zip","rar","tar","gz","py","js","java","c","cpp"].includes(e)?"code":"other"},te=async()=>{if(!w.value.length){_.warning("请选择要上传的文件");return}if(!m.type){_.warning("请选择资源类型");return}k.value=!0,$.value=0,v.value="uploading",V.value="";const t=w.value[0].raw;console.log("开始上传文件:",t.name);try{if(t.size>104857600)throw new Error("文件大小超过100MB限制，请选择更小的文件");const r=await $e(t,m.type);if(console.log("上传完成，结果:",r),r.success){const B={fileName:t.name,objectName:r.objectName,type:m.type,description:m.description,uploadTime:new Date().toLocaleString(),status:"success",url:r.url};g.value.unshift(B),localStorage.setItem("uploadHistory",JSON.stringify(g.value)),x.value=B,v.value="success",_({message:`文件 "${t.name}" 上传成功！`,type:"success",duration:3e3,showClose:!0,center:!0,customClass:"upload-success-message"}),setTimeout(()=>{A(),E.value="history"},3e3)}}catch(e){console.error("上传失败:",e),v.value="error",V.value=e.message||"上传过程中发生错误",_.error({message:`上传失败: ${e.message}`,duration:5e3,showClose:!0,center:!0})}finally{k.value=!1}},A=()=>{w.value=[],m.type="",m.description=""},D=t=>{I.value=t,N.value=!0},T=t=>{if(!t||!t.objectName){_.warning("文件信息不完整，无法下载");return}try{Ne(t.objectName,t.fileName),_.success("下载已开始")}catch(e){console.error("下载失败:",e),_.error(`下载失败: ${e.message}`)}},le=t=>{he.confirm(`确定要删除文件 "${t.fileName}" 吗？此操作无法撤销。`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await Ve(t.objectName),g.value=g.value.filter(e=>e.objectName!==t.objectName),se(),_.success("文件已删除")}catch(e){console.error("删除文件失败:",e),_.error(`删除文件失败: ${e.message}`)}}).catch(()=>{})},se=()=>{localStorage.setItem("uploadHistory",JSON.stringify(g.value))},oe=()=>{const t=localStorage.getItem("uploadHistory");t&&(g.value=JSON.parse(t))},ae=async()=>{try{console.log("正在检测OSS连接..."),await Ce(),console.log("OSS连接正常");try{const t=await Fe("",5);console.log("成功获取文件列表，数量:",t.length)}catch(t){console.warn("获取文件列表失败，可能是权限问题:",t)}}catch(t){console.error("OSS连接失败:",t),v.value="error";let e="";t.name==="SecurityError"?e="这可能是由于浏览器安全限制或跨域问题导致的。":t.message&&t.message.includes("Network")?e="这可能是网络连接问题。请检查您的网络连接并确保能够访问阿里云OSS服务。":t.message&&t.message.includes("AccessDenied")?e="这可能是由于AccessKey权限不足或Bucket权限设置错误导致的。":t.status===403?e="访问被拒绝，请检查您的AccessKey是否有效且具有足够的权限。":t.status===404&&(e="Bucket不存在或者路径错误。请检查您的Bucket名称是否正确。");const r=`
OSS连接排查指南：
1. 检查AccessKey是否正确
2. 确认Bucket名称和区域设置
3. 验证网络连接状态
4. 检查阿里云控制台中的权限设置
5. 考虑使用STS Token进行安全访问
    `;V.value=`OSS连接失败: ${t.message||"未知错误"}。${e}
${r}`,_.error({message:"检测到OSS连接问题，上传功能可能无法正常工作",duration:1e4})}};return ve(()=>{oe(),ae()}),(t,e)=>{var z;const r=u("el-icon"),B=u("el-upload"),ne=u("el-progress"),y=u("el-button"),H=u("el-alert"),re=u("el-divider"),C=u("el-option"),ie=u("el-select"),M=u("el-form-item"),ue=u("el-input"),de=u("el-form"),L=u("el-tab-pane"),ce=u("el-empty"),F=u("el-table-column"),S=u("el-tag"),pe=u("el-table"),me=u("el-tabs"),fe=u("el-dialog");return n(),b("div",je,[e[26]||(e[26]=a("div",{class:"page-header"},[a("h1",null,"文件上传"),a("p",{class:"header-subtitle"},"上传分享您的学习资料、论文、代码和笔记")],-1)),a("div",Oe,[a("div",Ee,[l(me,{modelValue:E.value,"onUpdate:modelValue":e[4]||(e[4]=o=>E.value=o),class:"custom-tabs"},{default:s(()=>[l(L,{label:"上传文件",name:"file"},{default:s(()=>[a("div",Ie,[l(B,{class:"upload-dragger",drag:"",action:"#","auto-upload":!1,"on-change":X,"on-remove":Z,"file-list":w.value,multiple:""},{tip:s(()=>e[8]||(e[8]=[a("div",{class:"el-upload__tip"}," 支持的文件类型：PDF、Markdown、代码文件、图片、视频等 ",-1)])),default:s(()=>[a("div",Te,[l(r,{class:"el-icon--upload"},{default:s(()=>[l(i(ye))]),_:1})]),e[9]||(e[9]=a("div",{class:"el-upload__text"},[d("拖拽文件到此处或 "),a("em",null,"点击上传")],-1))]),_:1},8,["file-list"]),$.value>0&&v.value==="uploading"?(n(),b("div",Me,[l(ne,{percentage:$.value,"stroke-width":10,status:""},null,8,["percentage"]),a("div",Ue,"文件上传中..."+h($.value.toFixed(0))+"%",1)])):p("",!0),v.value==="success"&&x.value?(n(),b("div",Ae,[l(H,{title:"上传成功",type:"success","show-icon":"",closable:!0,description:`文件 '${x.value.fileName}' 已成功上传`},{default:s(()=>[a("div",De,[l(y,{size:"small",onClick:e[0]||(e[0]=o=>D(x.value)),class:"preview-btn"},{default:s(()=>[l(r,null,{default:s(()=>[l(i(K))]),_:1}),e[10]||(e[10]=d("预览文件 "))]),_:1}),l(y,{size:"small",type:"primary",onClick:e[1]||(e[1]=o=>T(x.value)),class:"download-btn"},{default:s(()=>[l(r,null,{default:s(()=>[l(i(U))]),_:1}),e[11]||(e[11]=d("下载文件 "))]),_:1})])]),_:1},8,["description"])])):p("",!0),v.value==="error"?(n(),b("div",He,[l(H,{title:"上传失败",type:"error","show-icon":"",closable:!0,description:V.value},null,8,["description"])])):p("",!0),w.value.length?(n(),b("div",Le,[l(re,{"content-position":"center"},{default:s(()=>e[12]||(e[12]=[d("文件信息")])),_:1}),a("div",ze,[(n(!0),b(ge,null,we(w.value,(o,j)=>(n(),b("div",{key:j,class:"file-item"},[a("div",Ke,[l(r,{class:"file-type-icon"},{default:s(()=>[R(o.name)?(n(),c(i(O),{key:0})):q(o.name)?(n(),c(i(J),{key:1})):W(o.name)?(n(),c(i(xe),{key:2})):Y(o.name)?(n(),c(i(G),{key:3})):(n(),c(i(P),{key:4}))]),_:2},1024),a("span",null,h(o.name),1)]),a("div",Je,h(Q(o.size)),1)]))),128))]),a("div",Ge,[l(de,{"label-position":"top",model:m},{default:s(()=>[l(M,{label:"资源类型"},{default:s(()=>[l(ie,{modelValue:m.type,"onUpdate:modelValue":e[2]||(e[2]=o=>m.type=o),placeholder:"选择资源类型",style:{width:"100%"}},{default:s(()=>[l(C,{label:"论文",value:"paper"}),l(C,{label:"代码",value:"code"}),l(C,{label:"笔记",value:"note"}),l(C,{label:"视频",value:"video"}),l(C,{label:"其他",value:"other"})]),_:1},8,["modelValue"])]),_:1}),l(M,{label:"资源描述"},{default:s(()=>[l(ue,{modelValue:m.description,"onUpdate:modelValue":e[3]||(e[3]=o=>m.description=o),type:"textarea",rows:3,placeholder:"这一功能暂时没有开发，即使写了描述也没用"},null,8,["modelValue"])]),_:1}),l(M,null,{default:s(()=>[a("div",Pe,[l(y,{type:"primary",onClick:te,loading:k.value,disabled:v.value==="uploading",class:"upload-button"},{default:s(()=>[k.value?p("",!0):(n(),c(r,{key:0},{default:s(()=>[l(i(be))]),_:1})),d(" "+h(k.value?"上传中...":"上传文件"),1)]),_:1},8,["loading","disabled"]),l(y,{onClick:A,disabled:k.value||v.value==="uploading",class:"reset-button"},{default:s(()=>[l(r,null,{default:s(()=>[l(i(ke))]),_:1}),e[13]||(e[13]=d("重置 "))]),_:1},8,["disabled"])])]),_:1})]),_:1},8,["model"])])])):p("",!0)])]),_:1}),l(L,{label:"上传历史",name:"history"},{default:s(()=>[a("div",Xe,[g.value.length?(n(),c(pe,{key:1,data:g.value,style:{width:"100%"},class:"history-table"},{default:s(()=>[l(F,{label:"文件名",prop:"fileName"},{default:s(o=>[a("div",Ze,[l(r,{class:"file-icon"},{default:s(()=>[o.row.type==="paper"||o.row.type==="note"?(n(),c(i(O),{key:0})):p("",!0),o.row.type==="code"?(n(),c(i(J),{key:1})):p("",!0),o.row.type==="video"?(n(),c(i(G),{key:2})):p("",!0),o.row.type==="other"?(n(),c(i(P),{key:3})):p("",!0)]),_:2},1024),a("span",null,h(o.row.fileName),1)])]),_:1}),l(F,{label:"资源类型",prop:"type",width:"120"},{default:s(o=>[o.row.type==="paper"?(n(),c(S,{key:0,type:"primary",effect:"light",class:"resource-tag"},{default:s(()=>e[15]||(e[15]=[d("论文")])),_:1})):p("",!0),o.row.type==="code"?(n(),c(S,{key:1,type:"success",effect:"light",class:"resource-tag"},{default:s(()=>e[16]||(e[16]=[d("代码")])),_:1})):p("",!0),o.row.type==="note"?(n(),c(S,{key:2,type:"warning",effect:"light",class:"resource-tag"},{default:s(()=>e[17]||(e[17]=[d("笔记")])),_:1})):p("",!0),o.row.type==="video"?(n(),c(S,{key:3,type:"danger",effect:"light",class:"resource-tag"},{default:s(()=>e[18]||(e[18]=[d("视频")])),_:1})):p("",!0),o.row.type==="other"?(n(),c(S,{key:4,type:"info",effect:"light",class:"resource-tag"},{default:s(()=>e[19]||(e[19]=[d("其他")])),_:1})):p("",!0)]),_:1}),l(F,{label:"上传时间",prop:"uploadTime",width:"180"}),l(F,{label:"状态",prop:"status",width:"120"},{default:s(o=>[l(S,{type:o.row.status==="success"?"success":"danger",effect:"light",class:"status-tag"},{default:s(()=>[d(h(o.row.status==="success"?"成功":"失败"),1)]),_:2},1032,["type"])]),_:1}),l(F,{label:"操作",width:"200"},{default:s(o=>[a("div",Re,[l(y,{size:"small",onClick:j=>D(o.row),class:"action-btn preview-btn"},{default:s(()=>[l(r,null,{default:s(()=>[l(i(K))]),_:1}),e[20]||(e[20]=d("预览 "))]),_:2},1032,["onClick"]),l(y,{size:"small",type:"primary",onClick:j=>T(o.row),class:"action-btn download-btn"},{default:s(()=>[l(r,null,{default:s(()=>[l(i(U))]),_:1}),e[21]||(e[21]=d("下载 "))]),_:2},1032,["onClick"]),l(y,{size:"small",type:"danger",onClick:j=>le(o.row),class:"action-btn delete-btn"},{default:s(()=>[l(r,null,{default:s(()=>[l(i(Se))]),_:1}),e[22]||(e[22]=d("删除 "))]),_:2},1032,["onClick"])])]),_:1})]),_:1},8,["data"])):(n(),c(ce,{key:0,description:"暂无上传历史",class:"empty-history"},{image:s(()=>[l(r,{class:"empty-icon"},{default:s(()=>[l(i(O))]),_:1})]),description:s(()=>e[14]||(e[14]=[a("p",null,"您还没有上传过任何文件",-1)])),_:1}))])]),_:1})]),_:1},8,["modelValue"])])]),l(fe,{modelValue:N.value,"onUpdate:modelValue":e[7]||(e[7]=o=>N.value=o),title:((z=I.value)==null?void 0:z.fileName)||"文件预览",width:"80%","destroy-on-close":"",class:"preview-dialog"},{footer:s(()=>[l(y,{onClick:e[5]||(e[5]=o=>N.value=!1)},{default:s(()=>e[24]||(e[24]=[d("关闭")])),_:1}),l(y,{type:"primary",onClick:e[6]||(e[6]=o=>T(I.value)),class:"download-preview-btn"},{default:s(()=>[l(r,null,{default:s(()=>[l(i(U))]),_:1}),e[25]||(e[25]=d("下载 "))]),_:1})]),default:s(()=>[a("div",qe,[a("div",We,[l(r,{class:"preview-icon"},{default:s(()=>[l(i(O))]),_:1}),e[23]||(e[23]=a("p",null,"该文件类型暂不支持预览，请下载后查看",-1))])])]),_:1},8,["modelValue","title"])])}}},st=Be(Ye,[["__scopeId","data-v-0f7744ad"]]);export{st as default};
